#!/bin/bash

CONSUL_TOKEN_FILE="/apps/services/consul.token"
LOG_FILE="/apps/logs/microservice_registration.log"
CONSUL_URL="http://localhost:8500"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

load_consul_token() {
    if [[ -f "$CONSUL_TOKEN_FILE" ]]; then
        CONSUL_HTTP_TOKEN=$(<"$CONSUL_TOKEN_FILE")
        export CONSUL_HTTP_TOKEN
        return 0
    else
        log_message "Consul token file not found at $CONSUL_TOKEN_FILE"
        return 1
    fi
}

check_consul_client_ready() {
    local timeout=90
    local start_time
    start_time=$(date +%s)

    log_message "Checking if Consul client is ready..."

    load_consul_token || return 1

    while true; do
        local response
        response=$(curl -s --header "X-Consul-Token: $CONSUL_HTTP_TOKEN" "$CONSUL_URL/v1/agent/self")

        if [[ $response == *'"server":false'* && $response == *'"status":"alive"'* ]]; then
            log_message "Consul client is alive and connected."
            return 0
        fi

        if (( $(date +%s) - start_time >= timeout )); then
            log_message "Consul readiness check timed out after $timeout seconds."
            return 1
        fi

        sleep 2
    done
}

# Run the check when script is executed
check_consul_client_ready
