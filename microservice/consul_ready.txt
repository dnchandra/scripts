#!/bin/bash

TOKEN_FILE="/etc/consul/consul.token"

# Load token from file
if [ -f "$TOKEN_FILE" ]; then
    CONSUL_HTTP_TOKEN=$(cat "$TOKEN_FILE")
else
    echo "$(date): Consul token file not found!"
    exit 1
fi

# Wait for Consul readiness
timeout=90
start_time=$(date +%s)

while true; do
    agent_status=$(curl -s --header "X-Consul-Token: $CONSUL_HTTP_TOKEN" http://localhost:8500/v1/agent/self)

    if [[ $agent_status == *'"server":false'* && $agent_status == *'"status":"alive"'* ]]; then
        echo "$(date): Consul is alive and connected."
        exit 0
    fi

    current_time=$(date +%s)
    if (( current_time - start_time >= timeout )); then
        echo "$(date): Consul readiness timed out after $timeout seconds."
        exit 1
    fi

    sleep 2
done
