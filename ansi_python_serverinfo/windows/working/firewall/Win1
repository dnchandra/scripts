---
- name: Test Network Connectivity
  hosts: "{{ servers }}"
  tasks:
    - name: Display Input Variables
      debug:
        msg: "Destinations: {{ destinations }}, Ports: {{ ports }}, Protocol: {{ protocol }}"

    - name: Execute PowerShell command
      win_shell: |
        $ErrorActionPreference = "Stop"
        $destinations_list = {{ destinations.split('[ ,]+') | map('trim') | list | to_json }}
        $ports_list = "{{ ports }}"
        $protocol = "{{ protocol }}"
        $ports_array = $ports_list -split "[ ,]+"
        $results = @()
        foreach ($item_ip in $destinations_list) {
          foreach ($item_port in $ports_array) {
            if ($protocol -eq "tcp") {
              $result = Test-NetConnection -ComputerName $item_ip -Port $item_port
            } else {
              $result = Test-NetUDPPort -ComputerName $item_ip -Port $item_port
            }
            $results += @{
              Destination = $item_ip
              Port = $item_port
              PingSucceeded = $result.PingSucceeded
            }
          }
        }
        $results | ConvertTo-Json
      register: con

    - name: Display Script Output
      debug:
        var: con.stdout
