- name: Test Network Connectivity
  hosts: "{{ servers }}"
  tasks:
    - name: Execute PowerShell command
      win_shell: |
        $ErrorActionPreference = "Stop"
        $destinations_list = "{{ destinations.split(',') | map('trim') | list }}"
        $ports_list = "{{ ports }}"
        $protocol = "{{ protocol }}"
        foreach ($item_ip in $destinations_list) {
          $ports_array = $ports_list -split ","
          foreach ($item_port in $ports_array) {
            $item_port = $item_port.Trim()
            if ($protocol -eq "tcp") {
              Test-NetConnection -ComputerName $item_ip -Port $item_port
            } else {
              Test-NetUDPPort -ComputerName $item_ip -Port $item_port
            }
          }
        }
      register: con
