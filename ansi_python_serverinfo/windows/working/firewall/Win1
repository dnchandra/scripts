---
- name: Test Network Connectivity
  hosts: "{{ servers }}"
  tasks:
    - name: Execute PowerShell command
      win_shell: |
        $ErrorActionPreference = "Stop"
        $destinations_list = "{{ destinations.split(',') | map('trim') | list }}"
        $ports_list = "{{ ports.split(',') | map('trim') | list }}"
        $protocol = "{{ protocol }}"
        foreach ($item_ip in $destinations_list) {
          foreach ($item_port in $ports_list) {
            if ($protocol -eq "tcp") {
              $connectionResult = Test-NetConnection -ComputerName $item_ip -Port $item_port
            } else {
              $connectionResult = Test-NetUDPPort -ComputerName $item_ip -Port $item_port
            }
            Write-Host "Destination: $item_ip, Port: $item_port, Result: $($connectionResult.PingSucceeded)"
          }
        }
      register: con
