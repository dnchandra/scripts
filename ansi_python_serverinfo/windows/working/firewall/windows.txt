- name: test firewall on Windows
  hosts: "{{ servers }}"
  vars:
    destinations: []
    ports: []
    protocol: ""  # The protocol variable from Ansible Tower

  tasks:
    - name: Combine IP and Port Pairs
      set_fact:
        combined_destinations: "{{ combined_destinations | default([]) + [{'ip': item[0], 'port': item[1]}] }}"
      loop: "{{ destinations | zip(ports) | list }}"
      register: combined_results

    - name: Execute PowerShell command
      script: |
        $ErrorActionPreference = "Stop"
        $results = @()
        foreach ($item in $using:combined_results.results) {
          if ("{{ protocol }}" -eq "tcp") {
            $result = Test-NetConnection -ComputerName $item.ip -Port $item.port
            $status = if ($result.TcpTestSucceeded) { "success" } else { "fail" }
          } else {
            $result = Test-NetUDPPort -ComputerName $item.ip -Port $item.port
            $status = if ($result.UdpTestSucceeded) { "success" } else { "fail" }
          }
          $output = "{0} {1} {2}" -f $item.ip, $item.port, $status
          $results += $output
        }
        $results
      loop: "{{ combined_results.results | map(attribute='item') }}"
      register: con

    - debug:
        var: item.stdout_lines
      loop: "{{ con.results }}"
