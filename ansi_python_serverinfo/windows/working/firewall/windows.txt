---
- name: Check Network Connections
  hosts: "{{ servers }}"
  gather_facts: false

  vars:
    DestinationIPs: "{{ destination_ips }}"
    Ports: "{{ ports }}"
    Protocol: "{{ protocol }}"

  tasks:
    - name: Run PowerShell script on remote host
      win_shell: |
        $IPArray = "{{ DestinationIPs }}" -split ","
        $PortArray = "{{ Ports }}" -split ","
        
        foreach ($IP in $IPArray) {
            foreach ($Port in $PortArray) {
                try {
                    if ("{{ Protocol }}" -eq "tcp") {
                        $result = Test-NetConnection -ComputerName $IP -Port $Port
                        if ($result.TcpTestSucceeded) {
                            Write-Host "TCP connection to $IP on port $Port successful."
                        } else {
                            Write-Host "TCP connection to $IP on port $Port failed."
                        }
                    } elseif ("{{ Protocol }}" -eq "udp") {
                        # UDP checks are a bit more complex, as there's no direct cmdlet like Test-NetConnection
                        $url = "udp://$IP:$Port"
                        $response = Invoke-WebRequest -Uri $url -Method Get
                        if ($response.StatusCode -eq 200) {
                            Write-Host "UDP connection to $IP on port $Port successful."
                        } else {
                            Write-Host "UDP connection to $IP on port $Port failed."
                        }
                    } else {
                        Write-Host "Invalid protocol specified. Please use 'tcp' or 'udp'."
                    }
                } catch {
                    Write-Host "An error occurred for $IP:$Port - $_"
                }
            }
        }
