import xml.etree.ElementTree as ET
import pandas as pd

def extract_text(elem, tag_name):
    tag = elem.find(tag_name)
    if tag is not None:
        data = tag.find('data')
        return data.text.strip() if data is not None and data.text else ''
    return ''

def parse_samplers(xml_file):
    tree = ET.parse(xml_file)
    root = tree.getroot()
    samplers = []

    for sg in root.iter():
        if 'samplergroup' in sg.tag.lower():
            group_name = sg.attrib.get('name', '')
            for sampler in sg.findall(".//sampler"):
                sampler_name = sampler.attrib.get('name', '')

                # loop through all <process> elements inside plugins
                for process in sampler.findall(".//plugin//processes//process"):
                    alias = extract_text(process, 'alias')
                    search_string = extract_text(process, 'ID/searchString')
                    start = extract_text(process, 'start')
                    stop = extract_text(process, 'stop')

                    samplers.append({
                        "Sampler Group": group_name,
                        "Sampler Name": sampler_name,
                        "Alias": alias,
                        "Search String": search_string,
                        "Start Command": start,
                        "Stop Command": stop
                    })

    return samplers

def write_to_excel(xml_file, output_file):
    data = parse_samplers(xml_file)
    if data:
        df = pd.DataFrame(data)
        df.to_excel(output_file, index=False)
        print(f"✅ Sampler data written to: {output_file}")
    else:
        print("⚠️ No sampler data found.")

# Usage
write_to_excel("gateway.xml", "ITRS_Samplers.xlsx")
